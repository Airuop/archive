name: Backup

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    paths:
      - './tools/run.txt'
  schedule:
    - cron: '0 8 * * *'
    
jobs:
  main:
    name: Backup
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:

      - uses: actions/checkout@v6.0.1
      - uses: actions/setup-python@v6.1.0
        with:
          python-version: "3.11.14"

      - name: Set Timezone
        run: sudo timedatectl set-timezone 'Asia/Tehran'

      - name: Install Requirements
        run: |
          pip install requests

      - name: run py
        run: |
          python ./tools/backup.py

      - name: Commit & push Send_Json changes
        continue-on-error: true
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          
          # 1. Get latest from remote
          echo "ğŸ”„ Pulling latest changes..."
          git pull origin main || {
            echo "âš ï¸  Pull failed, trying with rebase..."
            git pull origin main --rebase
          }
          
          # 2. Check if previous step made any changes
          echo "ğŸ“Š Checking for changes..."
          if [ -z "$(git status --porcelain)" ]; then
            echo "âœ… No changes detected - nothing to commit"
            exit 0
          fi
          
          # 3. Show what changed
          echo "ğŸ“ Changes detected:"
          git status --porcelain
          
          # 4. Stage and commit
          echo "ğŸ’¾ Committing changes..."
          git add -A
          git commit -m "ğŸŒ¿  Node Archived - $(TZ='Asia/Tehran' date '+%Y-%m-%d %H:%M:%S')"
          
          # 5. Push
          echo "ğŸš€ Pushing to GitHub..."
          git push origin main
          echo "âœ… Done!"
